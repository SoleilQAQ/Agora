name: Release Mobile (Android + iOS)

'on':
  push:
    branches: [master]
    tags: ["v*"]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3). Leave empty to use pubspec.yaml version -> vX.Y.Z"
        required: false
        type: string
      create_tag:
        description: "Create & push the tag on manual run"
        required: true
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  android:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_FILE_B64: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.38.4
          channel: stable
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Prepare Android signing (push/tag only)
        if: github.event_name != 'pull_request'
        working-directory: android/app
        shell: bash
        run: |
          set -euo pipefail

          B64="${KEYSTORE_BASE64:-}"
          if [ -z "$B64" ]; then B64="${KEYSTORE_FILE_B64:-}"; fi
          if [ -z "$B64" ]; then
            echo "::error::Missing signing keystore secret. Set KEYSTORE_BASE64 (or legacy KEYSTORE_FILE) as base64."
            exit 1
          fi

          if [ -z "${KEYSTORE_PASSWORD:-}" ] || [ -z "${KEY_ALIAS:-}" ] || [ -z "${KEY_PASSWORD:-}" ]; then
            echo "::error::Missing signing secrets. Need KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD."
            exit 1
          fi

          # decode keystore to android/app/keystore.jks
          echo "$B64" | base64 --decode > keystore.jks

          # å¸¸è§è¯»å–æ–¹å¼ï¼šrootProject.file("key.properties")
          cat > ../key.properties <<EOF
          storeFile=keystore.jks
          storePassword=${KEYSTORE_PASSWORD}
          keyAlias=${KEY_ALIAS}
          keyPassword=${KEY_PASSWORD}
          EOF

          echo "Generated android/key.properties"

      - name: Build APK (debug for PR)
        if: github.event_name == 'pull_request'
        run: flutter build apk --debug

      - name: Build APK (release for push/tag/manual)
        if: github.event_name != 'pull_request'
        run: flutter build apk --release

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          if-no-files-found: error
          path: build/app/outputs/flutter-apk/*.apk

  ios:
    name: Build iOS IPA (unsigned)
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.38.4
          channel: stable
          cache: true

      - name: Pub get
        run: flutter pub get

      - name: Install CocoaPods (if needed)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods
          fi
          pod --version

      - name: Install pods
        working-directory: ios
        run: pod install --repo-update

      - name: Build iOS app (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Create unsigned .ipa from Runner.app
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/ios/ipa/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/ipa/Payload/Runner.app
          (cd build/ios/ipa && zip -r Agora-unsigned.ipa Payload)
          ls -al build/ios/ipa

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          if-no-files-found: error
          path: build/ios/ipa/Agora-unsigned.ipa

  release:
    name: Publish GitHub Release (single)
    needs: [android, ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
            if [[ -z "$TAG" ]]; then
              # ä»Ž pubspec.yaml è‡ªåŠ¨è¯»ç‰ˆæœ¬ï¼šversion: 1.2.3+4 -> v1.2.3
              VER="$(grep -E '^version:\s*' pubspec.yaml | head -n1 | awk '{print $2}' | cut -d+ -f1)"
              if [[ -z "$VER" ]]; then
                echo "::error::Cannot read version from pubspec.yaml (missing 'version: x.y.z')"
                exit 1
              fi
              TAG="v${VER}"
            fi
          else
            TAG="${{ github.ref_name }}"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Create & push tag (manual run only)
        if: github.event_name == 'workflow_dispatch' && inputs.create_tag
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"

          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing RELEASE_TOKEN secret. Create a PAT with repo/contents write and set as RELEASE_TOKEN."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "$TAG" || true
          git push origin "$TAG" || true

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: dist/android

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: dist/ios

      - name: Normalize filenames
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"
          mkdir -p dist/out

          APK="$(ls -1 dist/android/*release*.apk 2>/dev/null | head -n 1 || true)"
          if [ -z "$APK" ]; then
            APK="$(ls -1 dist/android/*.apk 2>/dev/null | head -n 1 || true)"
          fi
          if [ -z "$APK" ]; then
            echo "::error::No APK found in dist/android"
            exit 1
          fi
          cp "$APK" "dist/out/Agora-android-${TAG}.apk"

          if [ ! -f dist/ios/Agora-unsigned.ipa ]; then
            echo "::error::Missing dist/ios/Agora-unsigned.ipa"
            exit 1
          fi
          cp dist/ios/Agora-unsigned.ipa "dist/out/Agora-ios-unsigned-${TAG}.ipa"

          ls -al dist/out

      - name: Generate Release Notes (inline; no "Full Changelog:")
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"
          git fetch --tags --force

          PREV_TAG="$(git tag -l 'v*' --sort=-version:refname | grep -vx "$TAG" | head -n 1 || true)"

          if [[ -n "$PREV_TAG" ]]; then
            RANGE="${PREV_TAG}..HEAD"
            COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${PREV_TAG}...${TAG}"
          else
            RANGE="HEAD"
            COMPARE_URL=""
          fi

          OUT="dist/release_notes.md"
          mkdir -p dist

          echo "# ${TAG}" > "$OUT"
          echo "" >> "$OUT"

          if [[ -n "$PREV_TAG" ]]; then
            echo "**Changes since ${PREV_TAG}:**" >> "$OUT"
          else
            echo "**Changes:**" >> "$OUT"
          fi
          echo "" >> "$OUT"

          COMMITS="$(git log --no-merges --pretty=format:'%s (%h)' $RANGE || true)"

          feat="$(echo "$COMMITS" | grep -E '^(feat|feature)(\(.+\))?:' || true)"
          fix="$(echo "$COMMITS" | grep -E '^fix(\(.+\))?:' || true)"
          docs="$(echo "$COMMITS" | grep -E '^docs(\(.+\))?:' || true)"
          chore="$(echo "$COMMITS" | grep -E '^(chore|refactor|perf|test|build|ci|style)(\(.+\))?:' || true)"
          other="$(echo "$COMMITS" | grep -Ev '^(feat|feature|fix|docs|chore|refactor|perf|test|build|ci|style)(\(.+\))?:' || true)"

          add_section () {
            local title="$1"
            local body="$2"
            if [[ -n "${body//$'\n'/}" ]]; then
              echo "## ${title}" >> "$OUT"
              echo "" >> "$OUT"
              echo "$body" \
                | sed -E 's/^(feat|feature|fix|docs|chore|refactor|perf|test|build|ci|style)(\(.+\))?:\s*/- /' \
                | sed -E 's/^/- /' >> "$OUT"
              echo "" >> "$OUT"
            fi
          }

          add_section "âœ¨ Features" "$feat"
          add_section "ðŸ› Fixes" "$fix"
          add_section "ðŸ“š Docs" "$docs"
          add_section "ðŸ§° Chore / Refactor" "$chore"
          add_section "ðŸ”Ž Other" "$other"

          if [[ -n "$COMPARE_URL" ]]; then
            echo "---" >> "$OUT"
            echo "Compare: ${COMPARE_URL}" >> "$OUT"
          fi

          echo "Generated $OUT"
          sed -n '1,160p' "$OUT"

      - name: Create/Update Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_TOKEN || github.token }}
          tag_name: ${{ steps.vars.outputs.tag }}
          target_commitish: ${{ github.sha }}
          body_path: dist/release_notes.md
          generate_release_notes: false
          files: |
            dist/out/Agora-android-${{ steps.vars.outputs.tag }}.apk
            dist/out/Agora-ios-unsigned-${{ steps.vars.outputs.tag }}.ipa
